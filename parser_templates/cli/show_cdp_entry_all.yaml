---
- name: match cdp sections
  pattern_match:
    regex: "^----------------------------------------"
    match_all: yes
    match_greedy: yes
  register: context

- name: match cpd values
  pattern_group:
    - name: match name
      pattern_match:
        regex: "Device ID:(|\\s)(.+)\\("
        content: "{{ item }}"
      register: device_id

    - name: match interface
      pattern_match:
        regex: "Interface: (.+), Port ID \\(outgoing port\\): (.+)"
        content: "{{ item }}"
      register: interface

  loop: "{{ context }}"
  register: values

- name: build cdp template
  json_template:
    template:
      - key: "{{ item.device_id.matches.1 }}"
        object:
          - key: local_port
            value: "{{ item.interface.matches.0 }}"
          - key: remote_port
            value: "{{ item.interface.matches.1}}"
  loop: "{{ values }}"
  register: neighbors
  export: yes
  export_as: dict
  extend: cisco_nxos
